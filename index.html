<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Badminton Tension Meter</title>
    
    <!-- PWA / Mobile Capable Metatags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">

    <!-- Embedded Icon (SVG Base64) for PWA -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='100' fill='%2310b981'/%3E%3Cpath d='M256 120c-70 0-120 50-120 120 0 70 50 120 120 120s120-50 120-120c0-70-50-120-120-120zm0 20c55 0 100 45 100 100s-45 100-100 100-100-45-100-100 45-100 100-100z' fill='white' opacity='0.8'/%3E%3Cpath d='M256 160v160M176 240h160' stroke='%23059669' stroke-width='20' stroke-linecap='round'/%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='100' fill='%2310b981'/%3E%3Cpath d='M256 120c-70 0-120 50-120 120 0 70 50 120 120 120s120-50 120-120c0-70-50-120-120-120zm0 20c55 0 100 45 100 100s-45 100-100 100-100-45-100-100 45-100 100-100z' fill='white' opacity='0.8'/%3E%3Cpath d='M256 160v160M176 240h160' stroke='%23059669' stroke-width='20' stroke-linecap='round'/%3E%3C/svg%3E">

    <!-- Embedded Manifest for "Install App" prompt -->
    <link rel="manifest" href='data:application/manifest+json;base64,eyJuYW1lIjoiQmFkbWludG9uIFRlbnNpb24iLCJzaG9ydF9uYW1lIjoiVGVuc2lvbiIsInN0YXJ0X3VybCI6Ii4iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjZmZmZmZmIiwidGhlbWVfY29sb3IiOiIjMGYxNzJhIiwiaWNvbnMiOlt7InNyYyI6ImRhdGE6aW1hZ2Uvc3ZnK3htbCxiYXNlNjQsUEhOMmF5QjNhV1IzYVFBaVpXNWtJRDBnVlRBd0lIQnljM1I1YkdVZ2lRMEtDbTVoYldVaUlHbGtQVEl6TnpJaUlHMWhaR052YkdRpUlHZHZjbTltWlNoamFYUnlZVzVuUlhabGRHVnliV0ZzWVd4dlp5MGlNVEE1TUMweU56VXROR1JtWkMwME1HTmtMV1l6TkdFdFlqTXlaR1V4WkRGbVlqTmtJaUJ6ZEdGeVpEMGlaRzl0YVc1aE1TSWdhR1ZwWjJoMElIZHBaSFJvUFNJNVpITWlQanhEY21VNmJtRnRaUzloYm1SeWIybGtYek13T0Rjd09UY3dJaUJ3WVhSb0lHWnBiR3dpT2lKcGQyRjBaUzF6ZG1jK3htbCxQV0o1YjNSc2JTQnpkbWN2YzNCbmN3MEdjbVZqZEMxM2FXUjBhRDBpTlRFeU1TNDFNRElpSUhabGJHRjBaVjkwZVhCbFBTSXpNREl5Tmk0MU1ESWlJSFJ5YVdSMGFDMTBlWEJsUFNJeU5UQXlNaTQxTURJaUlIUnlhV1IwYUMxemRHVjJQVEl3T0Rjd09UY3dmUzh2YzNCbmN3PT0iLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCIsInNpemVzIjoiNTEyeDUxMiJ9XX0='>

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .meter-gradient { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .active-ring { box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.3); }
        select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            -webkit-appearance: none;
            appearance: none;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen flex flex-col items-center justify-center p-4">

    <!-- Main Container -->
    <div class="w-full max-w-md bg-white rounded-3xl shadow-xl overflow-hidden border border-slate-100">
        
        <!-- Header -->
        <div class="bg-slate-900 text-white p-6 text-center relative overflow-hidden">
            <div class="relative z-10">
                <h1 class="text-2xl font-bold tracking-tight">Badminton Tension</h1>
                <p class="text-slate-400 text-sm mt-1">Acoustic Frequency Analyzer</p>
            </div>
            <!-- Decorative circle -->
            <div class="absolute top-[-50%] left-[-20%] w-64 h-64 bg-emerald-500 rounded-full opacity-10 blur-3xl"></div>
        </div>

        <!-- Controls -->
        <div class="p-6 space-y-5">
            
            <!-- Racket Model Selector -->
            <div>
                 <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2">My Inventory</label>
                 <select id="racket-select" onchange="selectRacket(this.value)" class="w-full bg-slate-50 border border-slate-200 text-slate-700 text-sm rounded-lg focus:ring-emerald-500 focus:border-emerald-500 block p-2.5 font-medium">
                     <option value="custom">Custom / Manual</option>
                     
                     <optgroup label="Yonex">
                         <option value="ax100zz">Astrox 100ZZ (Blue/Kurenai)</option>
                         <option value="ax99pro">Astrox 99 Pro</option>
                         <option value="ax77pro">Astrox 77 Pro</option>
                         <option value="arc11">Arcsaber 11</option>
                         <option value="arc11pro">Arcsaber 11 Pro</option>
                         <option value="arc7pro">Arcsaber 7 Pro</option>
                         <option value="nf1000z">Nanoflare 1000Z</option>
                         <option value="nf700pro">Nanoflare 700 / 700 Pro</option>
                         <option value="nf270">Nanoflare 270SP / 170LT</option>
                         <option value="ns9000">Nanospeed 9000 Type S</option>
                         <option value="iso600">Isometric Power 600</option>
                         <option value="cab20">Carbonex 20 Tour</option>
                     </optgroup>

                     <optgroup label="Victor">
                        <option value="ars_hs">ARS-HS+ / Hendra</option>
                        <option value="ars90k2">Auraspeed 90K II</option>
                        <option value="dx10">DriveX 10 Metallic</option>
                        <option value="tkf">Thruster F Enhanced</option>
                        <option value="ars_fan">ARS-Fantôme</option>
                     </optgroup>

                     <optgroup label="Redson">
                        <option value="redson_shape">Shape ESG</option>
                        <option value="redson_beta">β-2000</option>
                     </optgroup>

                     <optgroup label="Felet">
                        <option value="felet_88">Woven Eighty8</option>
                     </optgroup>

                     <optgroup label="Fleet">
                        <option value="fleet_stellar">Stellar 10</option>
                        <option value="fleet_tri">TRIATTACK X80E</option>
                     </optgroup>

                     <optgroup label="Flypower">
                        <option value="fly_term">Terminator 101 S</option>
                     </optgroup>

                     <optgroup label="Jnice">
                        <option value="jnice_air">Elastic Air 73</option>
                        <option value="jnice_elves">ELASTIC ELVES 6 PRO</option>
                        <option value="jnice_panther">BLACK PANTHER</option>
                     </optgroup>

                 </select>
            </div>

            <!-- Settings Grid -->
            <div class="grid grid-cols-2 gap-4">
                <!-- Main String Selector -->
                <div>
                    <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2">Vertical (Main)</label>
                    <select id="main-string-select" onchange="setMainString(this.value)" class="w-full bg-slate-50 border border-slate-200 text-slate-700 text-sm rounded-lg focus:ring-emerald-500 focus:border-emerald-500 block p-2.5 font-medium">
                        <!-- Populated by JS -->
                    </select>
                </div>

                 <!-- Cross String Selector -->
                 <div>
                    <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2">Horiz. (Cross)</label>
                    <select id="cross-string-select" onchange="setCrossString(this.value)" class="w-full bg-slate-50 border border-slate-200 text-slate-700 text-sm rounded-lg focus:ring-emerald-500 focus:border-emerald-500 block p-2.5 font-medium">
                        <!-- Populated by JS -->
                    </select>
                </div>

                <!-- Pre-stretch Selector (Spans both columns) -->
                <div class="col-span-2">
                    <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2">Pre-Stretch (Both)</label>
                    <select id="pre-stretch-select" onchange="setPreStretch(this.value)" class="w-full bg-slate-50 border border-slate-200 text-slate-700 text-sm rounded-lg focus:ring-emerald-500 focus:border-emerald-500 block p-2.5 font-medium">
                        <option value="0">None (0%)</option>
                        <option value="5">5%</option>
                        <option value="10">10%</option>
                        <option value="15">15%</option>
                    </select>
                </div>
            </div>

            <!-- Display Area -->
            <div class="flex flex-col items-center justify-center space-y-2 py-2">
                <div class="relative w-48 h-48 rounded-full border-4 border-slate-100 flex items-center justify-center bg-slate-50 shadow-inner transition-all duration-300" id="circle-display">
                    
                    <div class="text-center z-10">
                        <span id="tension-value" class="block text-5xl font-bold text-slate-800 tracking-tighter">--</span>
                        <span class="text-sm font-semibold text-slate-400 uppercase">LBS</span>
                    </div>

                    <!-- Visualizer Ring -->
                    <canvas id="visualizer" class="absolute top-0 left-0 w-full h-full rounded-full opacity-0 transition-opacity duration-500 pointer-events-none"></canvas>
                </div>
                
                <div class="text-center h-6 flex flex-col justify-center">
                    <span id="hz-value" class="text-sm font-mono text-slate-400">Waiting for signal...</span>
                    <span id="config-summary" class="text-[10px] text-emerald-600 font-medium opacity-0 transition-opacity">Hybrid: 0.68mm / 0.61mm</span>
                </div>
            </div>

            <!-- Action Button -->
            <button id="toggle-btn" class="w-full py-4 rounded-xl text-white font-bold text-lg shadow-lg hover:shadow-xl transform active:scale-[0.98] transition-all flex items-center justify-center gap-2 meter-gradient">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>
                <span>Start Microphone</span>
            </button>

             <!-- Advanced Settings Toggle -->
             <div class="text-center">
                <button onclick="toggleSettings()" class="text-xs text-slate-400 underline decoration-slate-300 hover:text-slate-600">Calibration Settings</button>
            </div>

            <!-- Hidden Calibration -->
            <div id="settings-panel" class="hidden bg-slate-100 rounded-lg p-4 text-sm space-y-4">
                
                <!-- Manual String Gauge (New) -->
                <div class="space-y-3 pb-2 border-b border-slate-200">
                    <p class="text-xs font-bold text-slate-500 uppercase">Manual Gauge Override</p>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-slate-600 text-xs block mb-1">Main (mm)</label>
                            <input type="number" id="manual-main-gauge" step="0.01" class="w-full text-xs border border-slate-300 rounded px-2 py-1" oninput="manualGaugeUpdate('main', this.value)">
                        </div>
                        <div>
                            <label class="text-slate-600 text-xs block mb-1">Cross (mm)</label>
                            <input type="number" id="manual-cross-gauge" step="0.01" class="w-full text-xs border border-slate-300 rounded px-2 py-1" oninput="manualGaugeUpdate('cross', this.value)">
                        </div>
                    </div>
                </div>

                <!-- Geometry Settings (Always Visible) -->
                <div class="space-y-3 pb-2 border-b border-slate-200">
                    <p class="text-xs font-bold text-slate-500 uppercase">Geometry Settings</p>
                    <!-- Vertical Length -->
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label class="text-slate-600 text-xs">Vertical Length</label>
                            <span id="length-display" class="text-emerald-600 font-mono font-bold text-xs">24.5 cm</span>
                        </div>
                        <input type="range" id="length-slider" min="23.0" max="26.0" step="0.1" value="24.0" class="w-full accent-emerald-500" oninput="updateLength(this.value)">
                    </div>

                    <!-- Horizontal Length (Width) -->
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label class="text-slate-600 text-xs">Horizontal Width</label>
                            <span id="width-display" class="text-emerald-600 font-mono font-bold text-xs">18.5 cm</span>
                        </div>
                        <input type="range" id="width-slider" min="16.0" max="21.0" step="0.1" value="18.2" class="w-full accent-emerald-500" oninput="updateWidth(this.value)">
                    </div>
                    <p class="text-[10px] text-slate-400 italic">Moving sliders switches mode to Custom.</p>
                </div>

                <!-- Existing Manual Factor -->
                <div>
                    <div class="flex justify-between items-center mb-1">
                        <label class="text-slate-600 font-semibold text-xs">Manual Factor</label>
                        <span id="factor-display" class="text-emerald-600 font-mono font-bold text-xs">1.0x</span>
                    </div>
                    <input type="range" min="0.8" max="1.2" step="0.01" value="1.0" class="w-full accent-emerald-500" oninput="updateFactor(this.value)">
                    <p class="text-[10px] text-slate-400 mt-1">Leave at 1.0x unless results differ from machine.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Instructions -->
    <div class="mt-8 max-w-md text-slate-400 text-xs text-center leading-relaxed">
        <p><strong>Note:</strong> Microphone requires a secure context (HTTPS/Localhost).<br>If opening as a local file, some browsers may block access.</p>
    </div>

    <script>
        // --- Physics Constants ---
        const MATERIAL_DENSITY = 990; 
        
        // --- String Database ---
        const STRINGS = {
            'custom': { name: 'Custom', gauge: 0.68 },
            
            // Yonex
            'y_as': { name: 'Aerosonic', gauge: 0.61 },
            'y_xb63': { name: 'Exbolt 63', gauge: 0.63 },
            'y_xb65': { name: 'Exbolt 65', gauge: 0.65 },
            'y_xb68': { name: 'Exbolt 68', gauge: 0.68 },
            'y_bg66um': { name: 'BG66 Ultimax', gauge: 0.65 },
            'y_bg66f': { name: 'BG66 Force', gauge: 0.65 },
            'y_bg80': { name: 'BG80', gauge: 0.68 },
            'y_bg80p': { name: 'BG80 Power', gauge: 0.68 },
            'y_bg65': { name: 'BG65', gauge: 0.70 },
            'y_bg65ti': { name: 'BG65 Ti', gauge: 0.70 },
            'y_nbg95': { name: 'Nanogy 95', gauge: 0.69 },
            'y_nbg98': { name: 'Nanogy 98', gauge: 0.66 },
            'y_nbg99': { name: 'Nanogy 99', gauge: 0.69 },
            'y_ab_main': { name: 'Aerobite (Main)', gauge: 0.67 }, // PU Coating
            'y_ab_cross': { name: 'Aerobite (Cross)', gauge: 0.61 },
            'y_abb_main': { name: 'AB Boost (Main)', gauge: 0.72 },
            
            // Victor
            'v_vbs63': { name: 'VBS-63', gauge: 0.63 },
            'v_vbs66n': { name: 'VBS-66N', gauge: 0.66 },
            'v_vbs68': { name: 'VBS-68', gauge: 0.68 },
            'v_vbs70': { name: 'VBS-70', gauge: 0.70 },
            
            // Kizuna
            'k_z58': { name: 'Z58', gauge: 0.58 },
            'k_z61': { name: 'Z61 / D61', gauge: 0.61 },
            'k_z63': { name: 'Z63 / X63', gauge: 0.63 },
            'k_z64': { name: 'Z64', gauge: 0.64 },
            'k_z65': { name: 'Z65', gauge: 0.65 },
            'k_z69': { name: 'Z69', gauge: 0.69 },
        };

        const GROUPS = {
            'Yonex': ['y_as', 'y_xb63', 'y_xb65', 'y_xb68', 'y_bg66um', 'y_bg66f', 'y_bg80', 'y_bg80p', 'y_bg65', 'y_bg65ti', 'y_nbg95', 'y_nbg98', 'y_ab_main', 'y_ab_cross'],
            'Victor': ['v_vbs63', 'v_vbs66n', 'v_vbs68', 'v_vbs70'],
            'Kizuna': ['k_z58', 'k_z61', 'k_z63', 'k_z64', 'k_z65', 'k_z69']
        };

        // --- Audio State Variables ---
        let audioContext = null;
        let analyser = null;
        let microphone = null;
        let isListening = false;
        let animationId = null;

        let mainGauge = 0.68;
        let crossGauge = 0.68;
        let preStretchPercent = 0;
        let calibrationFactor = 1.0;
        
        // Geometry defaults
        let currentLength = 0.245; 
        let currentWidth = 0.185; 
        
        // Stabilizing readings
        let readingHistory = [];
        const HISTORY_SIZE = 5;

        // Racket Database
        const RACKETS = {
            'ax100zz': { l: 24.0, w: 18.2 }, 
            'ax99pro': { l: 24.5, w: 18.5 },
            'ax77pro': { l: 24.5, w: 18.5 },
            'arc11':   { l: 24.5, w: 18.5 },
            'arc11pro':{ l: 24.5, w: 18.5 },
            'arc7pro': { l: 24.5, w: 18.5 },
            'nf1000z': { l: 24.0, w: 18.3 },
            'nf700pro':{ l: 24.5, w: 18.7 },
            'nf270':   { l: 24.5, w: 18.5 },
            'ns9000':  { l: 24.5, w: 18.5 },
            'iso600':  { l: 24.5, w: 18.5 },
            'cab20':   { l: 23.5, w: 17.5 },
            'ars_hs':  { l: 24.0, w: 18.3 },
            'ars90k2': { l: 24.3, w: 18.4 },
            'dx10':    { l: 24.5, w: 18.5 },
            'tkf':     { l: 24.4, w: 18.4 },
            'ars_fan': { l: 24.5, w: 18.5 },
            'redson_shape': { l: 24.0, w: 18.7 },
            'redson_beta':  { l: 24.5, w: 18.5 },
            'felet_88': { l: 24.5, w: 18.7 },
            'fleet_stellar': { l: 24.5, w: 18.5 },
            'fleet_tri':     { l: 24.5, w: 18.5 },
            'fly_term':      { l: 24.5, w: 18.5 },
            'jnice_air':     { l: 24.5, w: 18.5 },
            'jnice_elves':   { l: 24.5, w: 18.5 },
            'jnice_panther': { l: 24.5, w: 18.5 }
        };

        // UI Elements
        const toggleBtn = document.getElementById('toggle-btn');
        const tensionDisplay = document.getElementById('tension-value');
        const hzDisplay = document.getElementById('hz-value');
        const configSummary = document.getElementById('config-summary');
        const canvas = document.getElementById('visualizer');
        const ctx = canvas.getContext('2d');
        const circleDisplay = document.getElementById('circle-display');
        const mainSelect = document.getElementById('main-string-select');
        const crossSelect = document.getElementById('cross-string-select');
        const lengthDisplay = document.getElementById('length-display');
        const widthDisplay = document.getElementById('width-display');
        const lengthSlider = document.getElementById('length-slider');
        const widthSlider = document.getElementById('width-slider');
        const racketSelectEl = document.getElementById('racket-select');
        const manualMainGauge = document.getElementById('manual-main-gauge');
        const manualCrossGauge = document.getElementById('manual-cross-gauge');

        // Init Gauge Dropdown
        function initDropdown() {
            let optionsHTML = `<option value="custom">Custom / Manual</option>`;
            
            for (const [brand, keys] of Object.entries(GROUPS)) {
                optionsHTML += `<optgroup label="${brand}">`;
                keys.forEach(key => {
                    const s = STRINGS[key];
                    // Select BG80 by default for example
                    let selected = key === 'y_bg80' ? 'selected' : '';
                    optionsHTML += `<option value="${key}" ${selected}>${s.name} (${s.gauge}mm)</option>`;
                });
                optionsHTML += `</optgroup>`;
            }

            mainSelect.innerHTML = optionsHTML;
            // Re-select for cross (BG80 default)
            crossSelect.innerHTML = optionsHTML;
            
            // Set initial inputs
            manualMainGauge.value = 0.68;
            manualCrossGauge.value = 0.68;
            updateSummary();
        }
        initDropdown();

        function resizeCanvas() {
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // --- Racket Logic ---
        function selectRacket(val) {
            if (val === 'custom') {
                currentLength = parseFloat(lengthSlider.value) / 100;
                currentWidth = parseFloat(widthSlider.value) / 100;
            } else {
                const specs = RACKETS[val];
                if (specs) {
                    currentLength = specs.l / 100;
                    currentWidth = specs.w / 100;
                    lengthSlider.value = specs.l;
                    widthSlider.value = specs.w;
                    lengthDisplay.textContent = specs.l + " cm";
                    widthDisplay.textContent = specs.w + " cm";
                }
            }
            clearReadings();
        }

        // --- String Logic ---
        function setMainString(key) {
            const s = STRINGS[key];
            if (s) {
                mainGauge = s.gauge;
                manualMainGauge.value = s.gauge;
            }
            clearReadings();
            updateSummary();
        }

        function setCrossString(key) {
            const s = STRINGS[key];
            if (s) {
                crossGauge = s.gauge;
                manualCrossGauge.value = s.gauge;
            }
            clearReadings();
            updateSummary();
        }

        function manualGaugeUpdate(type, val) {
            const floatVal = parseFloat(val);
            if (isNaN(floatVal)) return;

            if (type === 'main') {
                mainGauge = floatVal;
                // Set dropdown to custom
                mainSelect.value = 'custom';
            } else {
                crossGauge = floatVal;
                crossSelect.value = 'custom';
            }
            clearReadings();
            updateSummary();
        }

        function setPreStretch(val) {
            preStretchPercent = parseInt(val);
            clearReadings();
            updateSummary();
        }
        
        function updateSummary() {
            let text = "";
            // Find string names if possible
            const mainName = mainSelect.value === 'custom' ? 'Custom' : STRINGS[mainSelect.value].name;
            const crossName = crossSelect.value === 'custom' ? 'Custom' : STRINGS[crossSelect.value].name;

            if (mainGauge === crossGauge && mainSelect.value === crossSelect.value) {
                text = `${mainName} (${mainGauge}mm)`;
            } else {
                text = `${mainGauge}mm / ${crossGauge}mm`;
            }
            text += ` @ ${preStretchPercent}% PS`;
            
            configSummary.textContent = text;
            configSummary.classList.remove('opacity-0');
        }

        function clearReadings() {
            readingHistory = [];
            tensionDisplay.textContent = "--";
            hzDisplay.textContent = "Settings changed. Tap again.";
            // Reset color
            hzDisplay.className = "text-sm font-mono text-slate-400";
        }

        function toggleSettings() {
            document.getElementById('settings-panel').classList.toggle('hidden');
        }

        function updateLength(val) {
            currentLength = parseFloat(val) / 100; 
            lengthDisplay.textContent = val + " cm";
            racketSelectEl.value = 'custom';
            clearReadings();
        }

        function updateWidth(val) {
            currentWidth = parseFloat(val) / 100; 
            widthDisplay.textContent = val + " cm";
            racketSelectEl.value = 'custom';
            clearReadings();
        }

        function updateFactor(val) {
            calibrationFactor = parseFloat(val);
            const factorText = document.getElementById('factor-display');
            if(factorText) factorText.textContent = val + "x";
            clearReadings();
        }

        // --- Audio Logic ---

        async function startListening() {
            // Enhanced Error Handling for Local Files
            if (!window.isSecureContext) {
                hzDisplay.innerHTML = '<span class="text-rose-500 font-bold">Error: Insecure Context</span>';
                alert("Security Restriction: Microphone access requires a secure website (HTTPS) or localhost. \n\nIt will NOT work if opened directly as a local file (file://) on Android due to OS security.");
                return;
            }

            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                hzDisplay.innerHTML = '<span class="text-rose-500 font-bold">Error: API Not Supported</span>';
                alert("Browser Error: Audio API not supported in this specific browser context.");
                return;
            }

            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                microphone = audioContext.createMediaStreamSource(stream);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 4096; 
                microphone.connect(analyser);

                isListening = true;
                toggleBtn.innerHTML = `
                    <svg class="animate-pulse" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 6v12"/><path d="M6 12h12"/></svg>
                    <span>Listening...</span>
                `;
                toggleBtn.classList.add('bg-rose-500', 'hover:bg-rose-600');
                toggleBtn.classList.remove('meter-gradient');
                
                canvas.classList.remove('opacity-0');
                
                // Clear any previous error messages
                hzDisplay.className = "text-sm font-mono text-slate-400";
                hzDisplay.textContent = "Listening...";
                
                processAudio();

            } catch (err) {
                console.error(err);
                
                let userMsg = "Microphone access denied.";
                let shortMsg = "Error";

                if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                    userMsg = "Permission Denied: You must click 'Allow' to use the microphone.";
                    shortMsg = "Permission Denied";
                } else if (err.name === 'NotFoundError') {
                    userMsg = "No microphone found on this device.";
                    shortMsg = "No Mic Found";
                }
                
                alert(userMsg + "\n\nTechnical details: " + err.message);
                
                hzDisplay.innerHTML = `<span class="text-rose-500 font-bold">${shortMsg}</span>`;
            }
        }

        function stopListening() {
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }
            isListening = false;
            cancelAnimationFrame(animationId);
            
            toggleBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>
                <span>Start Microphone</span>
            `;
            toggleBtn.classList.remove('bg-rose-500', 'hover:bg-rose-600');
            toggleBtn.classList.add('meter-gradient');
            canvas.classList.add('opacity-0');
            hzDisplay.textContent = "Stopped.";
        }

        toggleBtn.addEventListener('click', () => {
            if (isListening) stopListening();
            else startListening();
        });

        // --- Signal Processing ---

        function calculateTension(frequency) {
            const r_main = (mainGauge / 1000) / 2;
            const area_main = Math.PI * (r_main * r_main);
            
            const r_cross = (crossGauge / 1000) / 2;
            const area_cross = Math.PI * (r_cross * r_cross);
            
            const avgArea = (area_main + area_cross) / 2;
            
            const stretchFactor = 1 + (preStretchPercent / 100);
            const preStretchMassFactor = 1 / stretchFactor;
            
            const linearMassKgPerM = (MATERIAL_DENSITY * avgArea) * preStretchMassFactor;

            const effectiveL = currentLength;
            
            const standardWidth = 0.185;
            const shapeFactor = 1 + 0.5 * ((currentWidth - standardWidth) / standardWidth);
            
            let tensionNewtons = 4 * linearMassKgPerM * (effectiveL * effectiveL) * (frequency * frequency);
            tensionNewtons = tensionNewtons * shapeFactor;

            let tensionLbs = tensionNewtons * 0.224809;
            tensionLbs = tensionLbs * calibrationFactor;

            return tensionLbs;
        }

        function processAudio() {
            if (!isListening) return;

            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            analyser.getByteFrequencyData(dataArray);

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = (canvas.width / 2) - 10;
            
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
            ctx.strokeStyle = '#e2e8f0';
            ctx.stroke();

            let sum = 0;
            for(let i = 0; i < bufferLength; i++) {
                sum += dataArray[i];
            }
            const average = sum / bufferLength;
            const scale = 1 + (average / 50); 
            
            if (average > 10) {
                 circleDisplay.style.transform = `scale(${Math.min(scale, 1.1)})`;
                 circleDisplay.style.borderColor = '#10b981';
            } else {
                 circleDisplay.style.transform = 'scale(1)';
                 circleDisplay.style.borderColor = '#f1f5f9';
            }

            const sampleRate = audioContext.sampleRate;
            let maxVal = 0;
            let maxIndex = 0;

            const minIndex = Math.floor(800 * 2 * bufferLength / sampleRate);
            const maxIndexSearch = Math.floor(1600 * 2 * bufferLength / sampleRate);

            for (let i = minIndex; i < maxIndexSearch; i++) {
                if (dataArray[i] > maxVal) {
                    maxVal = dataArray[i];
                    maxIndex = i;
                }
            }

            if (maxVal > 150) { 
                const prev = dataArray[maxIndex - 1];
                const curr = dataArray[maxIndex];
                const next = dataArray[maxIndex + 1];
                
                const delta = 0.5 * (prev - next) / (prev - 2*curr + next);
                const trueIndex = maxIndex + delta;
                const freq = trueIndex * sampleRate / (2 * bufferLength);

                updateReading(freq);
            }

            animationId = requestAnimationFrame(processAudio);
        }

        function updateReading(freq) {
            if (readingHistory.length > 0) {
                const last = readingHistory[readingHistory.length - 1];
                if (Math.abs(last - freq) > 50) {
                    readingHistory = [freq];
                } else {
                    readingHistory.push(freq);
                }
            } else {
                readingHistory.push(freq);
            }

            if (readingHistory.length > HISTORY_SIZE) {
                readingHistory.shift();
            }

            const avgFreq = readingHistory.reduce((a, b) => a + b, 0) / readingHistory.length;
            const lbs = calculateTension(avgFreq);

            hzDisplay.textContent = `${Math.round(avgFreq)} Hz`;
            tensionDisplay.textContent = lbs.toFixed(1);
        }
    </script>
</body>
</html>
